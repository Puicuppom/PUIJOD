<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUIJOD - Mario Block Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&family=Press+Start+2P&display=swap');

        :root {
            /* << --- VIBRANT COLORS UPDATED --- >> */
            --primary-color: #43B047; /* Mario Green */
            --danger-color: #ef4444;  /* Vibrant Red */
            --success-color: #22c55e; /* Vibrant Green */
            
            --mario-red: #E52521;
            --mario-yellow: #FAC000;
            --mario-blue: #5C94FC;
            --mario-brown: #D97B00;
            --mario-dark-brown: #8C4516;
            --text-color-dark: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--mario-blue);
            background-image: url("https://www.transparenttextures.com/patterns/cubes.png");
            color: var(--text-color-dark);
            padding: 2rem 0;
            image-rendering: pixelated;
        }
        
        .container { 
            max-width: 840px;
            margin: auto; 
            padding: 15px; 
        }
        .hidden { display: none !important; }

        /* --- MARIO HEADER --- */
        header { 
            text-align: center; 
            margin-bottom: 30px;
            background: rgba(0,0,0,0.4);
            padding: 25px 20px;
            border: 4px solid #000;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        header h1 {
            font-family: 'Press Start 2P', cursive;
            color: var(--mario-yellow);
            text-shadow: 3px 3px #000;
            font-size: 2rem;
            line-height: 1.2;
        }
        header p#user-email-display { 
            color: #fff; 
            font-size: 0.9rem; 
            word-break: break-all;
            font-family: 'Kanit', sans-serif;
        }
        #logout-btn { 
            font-family: 'Press Start 2P', cursive;
            background-color: var(--mario-red); 
            color: white;
            width: auto; 
            padding: 10px 20px; 
            display: inline-block; 
            font-size: 0.9rem;
            border: 2px solid #000;
            box-shadow: 4px 4px 0px 0px var(--text-color-dark);
            cursor: pointer;
            transition: all 0.1s ease-out;
            border-radius: 8px;
        }
        #logout-btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        /* --- 8-BIT BLOCK SECTIONS --- */
        .section {
            background: var(--mario-brown);
            padding: 25px;
            border-radius: 0;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.8);
            margin-bottom: 25px;
            border: 4px solid #000;
            color: #fff;
        }
        .section-title {
            text-align: center;
            margin-bottom: 25px;
            color: #fff;
            font-weight: 600;
            font-size: 1.5rem;
            text-shadow: 2px 2px #000;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            text-shadow: 1px 1px #000;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #000;
            border-radius: 0;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.5);
        }

        button {
            display: block;
            width: 100%;
            padding: 14px;
            border: 2px solid #000;
            border-radius: 0;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Kanit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.1s ease-out;
        }
        button:active { 
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        .positive { color: var(--success-color) !important; font-weight: bold; }
        .negative { color: var(--danger-color) !important; font-weight: bold; }

        .dashboard { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 25px;
        }
        
        .card {
            background: var(--mario-yellow);
            padding: 20px;
            border-radius: 0;
            border: 4px solid #000;
            text-align: center;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.8);
        }
        .card h3 { 
            font-size: 0.9rem; 
            color: rgba(0,0,0,0.8); 
            font-weight: 500; 
            margin-bottom: 12px;
        }
        .card .amount { 
            font-size: 1.4rem; /* << --- FONT SIZE ADJUSTED --- >> */
            font-weight: 700;
            color: #000;
            word-break: break-all;
        }
        
        .view-toggle { 
            display: flex; 
            margin-bottom: 25px; 
            border: 2px solid #000;
        }
        .view-toggle-btn { 
            flex: 1; 
            padding: 10px; 
            background: var(--mario-dark-brown); 
            border: none;
            border-left: 2px solid #000;
            cursor: pointer; 
            font-family: 'Kanit'; 
            font-size: 1rem; 
            color: #fff; 
            font-weight: 500; 
        }
        .view-toggle-btn:first-child { border-left: none; }
        .view-toggle-btn.active { 
            background-color: var(--primary-color); 
            color: white;
            font-weight: 600;
        }

        .list-group-header {
            background-color: var(--mario-dark-brown);
            padding: 15px 20px;
            border: 2px solid #000;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        /* Override positive/negative colors for the header for better contrast */
        .list-group-header .positive { color: #80FFAF !important; }
        .list-group-header .negative { color: #FF8A8A !important; }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 2px dashed #000;
            color: #000;
        }
        .sub-list { 
            background: #fff; 
            border: 2px solid #000;
            border-top: none;
        }
        
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { 
            background: var(--mario-brown);
            padding: 30px; 
            border: 4px solid #000;
            width: 100%; 
            max-width: 500px; 
            color: #fff;
        }
        
        @media (min-width: 600px) {
            .dashboard { grid-template-columns: repeat(4, 1fr); }
        }
        /* === MODIFIED FOR MOBILE VIEW === */
        @media (max-width: 480px) {
            .dashboard { grid-template-columns: repeat(2, 1fr); } /* ปรับเป็น 2 คอลัมน์สำหรับมือถือ */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- AUTH CONTAINER -->
        <div id="auth-container">
            <div id="login-view" class="section auth-form">
                <h2 class="section-title">เข้าสู่ระบบ</h2>
                <form id="login-form">
                    <div class="form-group"><label for="login-email">อีเมล</label><input type="email" id="login-email" required></div>
                    <div class="form-group"><label for="login-password">รหัสผ่าน</label><input type="password" id="login-password" required></div>
                    <button type="submit">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>

        <!-- MAIN APP CONTAINER -->
        <div id="app-container" class="hidden">
            <!-- MARIO HEADER -->
            <header>
                <h1>MY COINS</h1>
                <p id="user-email-display"></p>
                <button id="logout-btn">QUIT</button>
            </header>

            <!-- === DATE FILTER MOVED HERE === -->
            <div class="filter-section section" style="display:flex; gap: 15px;">
                <div class="form-group" style="flex:1; margin-bottom: 0;"><label for="year-filter">ปี</label><select id="year-filter"></select></div>
                <div class="form-group" style="flex:1; margin-bottom: 0;"><label for="month-filter">เดือน</label><select id="month-filter"></select></div>
            </div>
            
            <!-- MARIO DASHBOARD -->
            <div class="dashboard">
                <div class="card"><h3>คงเหลือ (สะสม)</h3><p class="amount" id="balance">฿0.00</p></div>
                <div class="card"><h3>รายรับ (เดือนนี้)</h3><p class="amount" id="total-income">฿0.00</p></div>
                <div class="card"><h3>รายจ่าย (เดือนนี้)</h3><p class="amount" id="total-expense">฿0.00</p></div>
                <!-- === MODIFIED CARD === -->
                <div class="card"><h3>ผลต่าง (เดือนนี้)</h3><p class="amount" id="monthly-difference">฿0.00</p></div>
            </div>

            <div class="view-toggle">
                <button class="view-toggle-btn active" onclick="setView('transactions')">ดูรายการ</button>
                <button class="view-toggle-btn" onclick="setView('summary')">ดูสรุป</button>
            </div>

            <div id="transaction-view">
                <!-- Date filter was removed from here -->
                <div class="section">
                    <h2 class="section-title">ประวัติรายการ</h2>
                    <div id="list"></div>
                </div>
            </div>

            <div id="summary-view" class="hidden">
                <div class="section">
                    <h2 class="section-title">สรุปรายปี <span id="summary-year-title"></span></h2>
                    <div style="overflow-x:auto; background: #fff; color: #000; padding: 10px; border: 2px solid #000;">
                        <table id="summary-table" style="width: 100%; border-collapse: collapse;"></table>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">เพิ่มรายการ</h2>
                <form id="transaction-form">
                    <div class="form-group"><label for="type">ประเภท</label><select id="type"><option value="รายรับ">รายรับ</option><option value="รายจ่าย">รายจ่าย</option><option value="รายจ่าย (บัตรเครดิต)">รายจ่าย (บัตรเครดิต)</option></select></div>
                    <div class="form-group"><label for="description">รายละเอียด</label><input type="text" id="description" required></div>
                    <div class="form-group"><label for="amount">จำนวนเงิน</label><input type="number" step="0.01" id="amount" required></div>
                    <div class="form-group"><label for="transaction_date">วันที่</label><input type="date" id="transaction_date" required></div>
                    <button type="submit">เพิ่มรายการ</button>
                </form>
            </div>
            
             <div class="section actions-section" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <button class="action-btn" id="export-template-btn" style="background-color: #6c757d;">Export Template</button>
                <button class="action-btn" id="export-data-btn" style="background-color: #6c757d;">Export Data</button>
                <button class="action-btn" id="import-btn" style="background-color: #6c757d;">Import XLSX</button>
                <input type="file" id="import-file" class="hidden" accept=".xlsx, .xls">
            </div>
        </div>
    </div>
    
    <!-- EDIT TRANSACTION MODAL -->
    <div id="edit-modal-container" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="section-title">แก้ไขรายการ</h2>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                <div class="form-group"><label for="edit-type">ประเภท</label><select id="edit-type"><option value="รายรับ">รายรับ</option><option value="รายจ่าย">รายจ่าย</option><option value="รายจ่าย (บัตรเครดิต)">รายจ่าย (บัตรเครดิต)</option></select></div>
                <div class="form-group"><label for="edit-description">รายละเอียด</label><input type="text" id="edit-description" required></div>
                <div class="form-group"><label for="edit-amount">จำนวนเงิน</label><input type="number" step="0.01" id="edit-amount" required></div>
                <div class="form-group"><label for="edit-transaction_date">วันที่</label><input type="date" id="edit-transaction_date" required></div>
                <div class="modal-actions" style="display:flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()" style="background-color: #6c757d;">ยกเลิก</button>
                    <button type="submit">บันทึกการแก้ไข</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Javascript -->
    <script>
        const SUPABASE_URL = "https://fmbympgecspgqtnazrbm.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtYnltcGdlY3NwZ3F0bmF6cmJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDkwOTksImV4cCI6MjA2NjMyNTA5OX0.rqOrNDNRTF7WnDS6utTTKfFoNZKPiMZV_ttqYzYCaJs";
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allTransactions = [];
        let currentView = 'transactions';

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const yearFilterEl = document.getElementById('year-filter');
        const monthFilterEl = document.getElementById('month-filter');
        const transactionDateEl = document.getElementById('transaction_date');
        const transactionView = document.getElementById('transaction-view');
        const summaryView = document.getElementById('summary-view');
        const userEmailDisplay = document.getElementById('user-email-display');
        const editModalContainer = document.getElementById('edit-modal-container');

        // ---- AUTH ----
        const handleLogin = async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await db.auth.signInWithPassword({ email, password }); if (error) alert(error.message); };
        const handleLogout = async () => { const { error } = await db.auth.signOut(); if (error) console.error("Logout Error:", error); };
        
        // ---- CORE APP LOGIC ----
        const fetchAllTransactions = async () => {
            const { data, error } = await db.from('transactions').select('*').order('transaction_date', { ascending: true });
            if (error) { console.error('Error fetching transactions:', error); return; }
            allTransactions = data;
            renderUI();
        };

        const addTransaction = async (e) => {
            e.preventDefault();
            const { data: { user } } = await db.auth.getUser();
            const newTransaction = { user_id: user.id, type: document.getElementById('type').value, description: document.getElementById('description').value, amount: +document.getElementById('amount').value, transaction_date: transactionDateEl.value };
            const { error } = await db.from('transactions').insert(newTransaction);
            if (error) { console.error('Error adding transaction:', error); alert('เกิดข้อผิดพลาด: ' + error.message); return; }
            await fetchAllTransactions();
            document.getElementById('transaction-form').reset();
            transactionDateEl.valueAsDate = new Date();
        };

        const removeTransaction = async (id) => {
            if (!confirm('คุณแน่ใจว่าต้องการลบรายการนี้?')) return;
            const { error } = await db.from('transactions').delete().eq('id', id);
            if (error) { console.error('Error deleting transaction:', error); alert('เกิดข้อผิดพลาด: ' + error.message); return; }
            await fetchAllTransactions();
        };
        
        // ---- EDIT MODAL LOGIC ----
        window.openEditModal = (id) => {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;
            document.getElementById('edit-transaction-id').value = transaction.id;
            document.getElementById('edit-type').value = transaction.type;
            document.getElementById('edit-description').value = transaction.description;
            document.getElementById('edit-amount').value = transaction.amount;
            document.getElementById('edit-transaction_date').value = transaction.transaction_date;
            editModalContainer.classList.remove('hidden');
        };

        window.closeEditModal = () => { editModalContainer.classList.add('hidden'); };

        const handleUpdateTransaction = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-transaction-id').value;
            const updatedTransaction = { type: document.getElementById('edit-type').value, description: document.getElementById('edit-description').value, amount: +document.getElementById('edit-amount').value, transaction_date: document.getElementById('edit-transaction_date').value };
            const { error } = await db.from('transactions').update(updatedTransaction).eq('id', id);
            if (error) { console.error('Error updating transaction:', error); alert('เกิดข้อผิดพลาด: ' + error.message); return; }
            closeEditModal();
            await fetchAllTransactions();
        };

        // ---- UI & FILTERING & VIEW ----
        window.setView = (view) => {
            currentView = view;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.view-toggle-btn[onclick="setView('${view}')"]`).classList.add('active');
            transactionView.classList.toggle('hidden', view !== 'transactions');
            summaryView.classList.toggle('hidden', view !== 'summary');
            renderUI();
        };

        const renderUI = () => {
            if (!yearFilterEl.value || !monthFilterEl.value) return; 
            const selectedYear = parseInt(yearFilterEl.value);
            const selectedMonth = parseInt(monthFilterEl.value);
            const monthlyTransactions = allTransactions.filter(t => { const date = new Date(t.transaction_date); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return date.getFullYear() === selectedYear && (date.getMonth() + 1) === selectedMonth; });
            const upToCurrentMonthTransactions = allTransactions.filter(t => { const transDate = new Date(t.transaction_date); transDate.setMinutes(transDate.getMinutes() + transDate.getTimezoneOffset()); const lastDayOfMonth = new Date(selectedYear, selectedMonth, 0); return transDate <= lastDayOfMonth; });
            updateDashboard(monthlyTransactions, upToCurrentMonthTransactions);
            if (currentView === 'transactions') { 
                renderTransactionList(monthlyTransactions.slice().sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date)));
            } else { 
                const yearlyTransactions = allTransactions.filter(t => { const date = new Date(t.transaction_date); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return date.getFullYear() === selectedYear; });
                renderSummary(yearlyTransactions, selectedYear);
            }
        };
        
        // === JAVASCRIPT LOGIC UPDATED HERE ===
        const updateDashboard = (monthlyTransactions, upToCurrentMonthTransactions) => {
            const income = monthlyTransactions.filter(t => t.type === 'รายรับ').reduce((acc, t) => acc + t.amount, 0);
            const expense = monthlyTransactions.filter(t => t.type === 'รายจ่าย').reduce((acc, t) => acc + t.amount, 0);
            const credit = monthlyTransactions.filter(t => t.type === 'รายจ่าย (บัตรเครดิต)').reduce((acc, t) => acc + t.amount, 0);
            const totalExpense = expense + credit;
            const difference = income - totalExpense; // Calculate the difference
            
            const cumulativeBalance = upToCurrentMonthTransactions.reduce((acc, t) => (t.type === 'รายรับ' ? acc + t.amount : acc - t.amount), 0);

            document.getElementById('balance').innerHTML = `฿${formatMoney(cumulativeBalance)}`;
            document.getElementById('total-income').innerHTML = `฿${formatMoney(income)}`;
            document.getElementById('total-expense').innerHTML = `฿${formatMoney(totalExpense)}`;

            // Update the new difference element
            const differenceEl = document.getElementById('monthly-difference');
            differenceEl.innerHTML = `฿${formatMoney(difference)}`;
            differenceEl.classList.remove('positive', 'negative');
            if (difference >= 0) {
                differenceEl.classList.add('positive');
            } else {
                differenceEl.classList.add('negative');
            }
        };
        
        const renderTransactionList = (transactions) => {
            const listEl = document.getElementById('list');
            listEl.innerHTML = '';
            if (transactions.length === 0) { listEl.innerHTML = '<p style="text-align: center; padding: 20px 0; background:#fff; color:#000;">ไม่พบรายการในเดือนนี้</p>'; return; }
            const groupedByType = transactions.reduce((groups, t) => { const type = t.type; if (!groups[type]) { groups[type] = []; } groups[type].push(t); return groups; }, {});
            const groupOrder = ['รายรับ', 'รายจ่าย', 'รายจ่าย (บัตรเครดิต)'];
            groupOrder.forEach(type => {
                if (!groupedByType[type]) return; 
                const groupContainer = document.createElement('div');
                const header = document.createElement('div');
                header.className = 'list-group-header';
                header.onclick = () => { subList.classList.toggle('hidden'); };
                const groupTotal = groupedByType[type].reduce((sum, t) => sum + t.amount, 0);
                const totalClass = type === 'รายรับ' ? 'positive' : 'negative';
                const totalSign = type === 'รายรับ' ? '+' : '-';
                header.innerHTML = `<span>${type}</span><span class="group-total ${totalClass}">${totalSign}${formatMoney(groupTotal)}</span>`;
                const subList = document.createElement('ul');
                subList.className = 'sub-list hidden';
                groupedByType[type].forEach(t => {
                    const item = document.createElement('li');
                    item.className = 'transaction-item';
                    const sign = t.type === 'รายรับ' ? '+' : '-';
                    const itemClass = t.type === 'รายรับ' ? 'positive' : 'negative';
                    const formattedDate = new Date(t.transaction_date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', calendar: 'buddhist', timeZone: 'UTC' });
                    item.innerHTML = `<div class="item-details" style="display:flex; flex-direction: column; gap: 4px;"><span class="item-name" style="font-weight: 500;">${t.description}</span><span class="item-type" style="font-size: 0.85rem; color: #666;">${formattedDate}</span></div><div class="item-actions" style="display:flex; align-items:center; gap: 8px;"><span class="item-amount ${itemClass}" style="font-weight: 600; margin-right: 10px;">${sign}฿${formatMoney(t.amount)}</span><button class="edit-btn" onclick="openEditModal(${t.id})" style="background:#f59e0b; padding:6px 10px; font-size: 0.8rem; border-radius: 8px; border:none; color:white;">แก้ไข</button><button class="delete-btn" onclick="removeTransaction(${t.id})" style="background:var(--danger-color); padding:6px 10px; font-size: 0.8rem; border-radius: 8px; border:none; color:white;">ลบ</button></div>`;
                    subList.appendChild(item);
                });
                groupContainer.appendChild(header);
                groupContainer.appendChild(subList);
                listEl.appendChild(groupContainer);
            });
        };

        const renderSummary = (yearlyTransactions, year) => {
            document.getElementById('summary-year-title').innerText = `พ.ศ. ${year + 543}`;
            const startDateOfYear = new Date(year, 0, 1);
            let runningBalance = allTransactions.filter(t => { const transDate = new Date(t.transaction_date); transDate.setMinutes(transDate.getMinutes() + transDate.getTimezoneOffset()); return transDate < startDateOfYear; }).reduce((acc, t) => (t.type === 'รายรับ' ? acc + t.amount : acc - t.amount), 0);
            const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            let summaryData = Array(12).fill(0).map((_, i) => ({ month: thaiMonths[i], income: 0, expense: 0, credit: 0 }));
            yearlyTransactions.forEach(t => { const date = new Date(t.transaction_date); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); const monthIndex = date.getMonth(); if (t.type === 'รายรับ') summaryData[monthIndex].income += t.amount; else if (t.type === 'รายจ่าย') summaryData[monthIndex].expense += t.amount; else if (t.type === 'รายจ่าย (บัตรเครดิต)') summaryData[monthIndex].credit += t.amount; });
            const tableEl = document.getElementById('summary-table');
            let tableHTML = `<thead><tr style="background-color: #f0f0f0;"><th style="padding: 12px 8px; text-align: center;">เดือน</th><th style="padding: 12px 8px; text-align: center;">รายรับ</th><th style="padding: 12px 8px; text-align: center;">รายจ่าย</th><th style="padding: 12px 8px; text-align: center;">บัตรเครดิต</th><th style="padding: 12px 8px; text-align: center;">คงเหลือสะสม</th></tr></thead><tbody>`;
            let total = { income: 0, expense: 0, credit: 0 };
            summaryData.forEach(data => { 
                runningBalance += data.income - (data.expense + data.credit); 
                total.income += data.income; 
                total.expense += data.expense; 
                total.credit += data.credit; 
                tableHTML += `<tr style="border-bottom: 1px solid #ddd;">
                                <td style="text-align: left; padding: 12px 8px; font-weight: 500;">${data.month}</td>
                                <td class="positive" style="text-align: right; padding: 12px 8px;">${formatMoney(data.income)}</td>
                                <td class="negative" style="text-align: right; padding: 12px 8px;">${formatMoney(data.expense)}</td>
                                <td class="negative" style="text-align: right; padding: 12px 8px;">${formatMoney(data.credit)}</td>
                                <td class="${runningBalance >= 0 ? 'positive' : 'negative'}" style="text-align: right; padding: 12px 8px;">${formatMoney(runningBalance)}</td>
                              </tr>`; 
            });
            tableHTML += `</tbody><tfoot style="font-weight: bold; background-color: #f0f0f0;">
                            <tr>
                                <td style="text-align: left; padding: 12px 8px;">รวม</td>
                                <td class="positive" style="text-align: right; padding: 12px 8px;">${formatMoney(total.income)}</td>
                                <td class="negative" style="text-align: right; padding: 12px 8px;">${formatMoney(total.expense)}</td>
                                <td class="negative" style="text-align: right; padding: 12px 8px;">${formatMoney(total.credit)}</td>
                                <td class="${runningBalance >= 0 ? 'positive' : 'negative'}" style="text-align: right; padding: 12px 8px;">${formatMoney(runningBalance)}</td>
                            </tr>
                          </tfoot>`;
            tableEl.innerHTML = tableHTML;
        };

        const populateDateFilters = () => {
            const START_YEAR = 2024; 
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            yearFilterEl.innerHTML = '';
            for (let i = currentYear + 1; i >= START_YEAR; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 543;
                yearFilterEl.appendChild(option);
            }

            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            monthFilterEl.innerHTML = '';
            thaiMonths.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthFilterEl.appendChild(option);
            });
            
            yearFilterEl.value = Math.max(currentYear, START_YEAR);
            monthFilterEl.value = currentMonth;
        };
        
        const formatMoney = (number) => Number(number).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');

        const XLSX_HEADERS = ['transaction_date', 'type', 'description', 'amount'];
        const exportTemplate = () => { const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([ XLSX_HEADERS ]); const dropdownOptions = '"รายรับ,รายจ่าย,รายจ่าย (บัตรเครดิต)"'; ws['!dataValidation'] = [{ sqref: 'B2:B1000', opts: { type: 'list', allowBlank: true, formula1: dropdownOptions, showDropDown: true, errorStyle: 'warning', error: 'กรุณาเลือกจากรายการ', errorTitle: 'ข้อมูลไม่ถูกต้อง' } }]; XLSX.utils.book_append_sheet(wb, ws, "Transactions"); XLSX.writeFile(wb, "template.xlsx"); };
        const exportData = () => { if (allTransactions.length === 0) { alert("ไม่มีข้อมูลสำหรับ Export"); return; } const dataToExport = allTransactions.map(({ id, user_id, created_at, ...rest }) => ({...rest, transaction_date: new Date(rest.transaction_date).toLocaleDateString('en-CA') })); const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(dataToExport, { header: XLSX_HEADERS }); XLSX.utils.book_append_sheet(wb, ws, "Transactions"); XLSX.writeFile(wb, "transactions_export.xlsx"); };
        const formatDateForSupabase = (excelDate) => { try { if (excelDate instanceof Date) { return excelDate.toISOString().split('T')[0]; } if (typeof excelDate === 'number') { const jsDate = new Date(Math.round((excelDate - 25569) * 86400 * 1000)); return jsDate.toISOString().split('T')[0]; } if (typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) { return excelDate; } throw new Error("Invalid date format"); } catch (e) { console.error("Could not parse date:", excelDate); return null; } };
        const importFromXLSX = (event) => { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = async (e) => { try { const data = e.target.result; const workbook = XLSX.read(data, { type: 'binary', cellDates:true }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const json = XLSX.utils.sheet_to_json(worksheet); const { data: { user } } = await db.auth.getUser(); if (!user) { throw new Error("ไม่พบข้อมูลผู้ใช้"); } const newTransactions = []; const validTypes = ['รายรับ', 'รายจ่าย', 'รายจ่าย (บัตรเครดิต)']; for (const row of json) { const formattedDate = formatDateForSupabase(row.transaction_date); const amount = parseFloat(row.amount); const type = row.type ? String(row.type).trim() : null; if (formattedDate && type && validTypes.includes(type) && row.description && !isNaN(amount)) { newTransactions.push({ user_id: user.id, transaction_date: formattedDate, type: type, description: String(row.description), amount: amount, }); } else { console.warn('ข้ามแถวข้อมูลที่ไม่ถูกต้อง:', row); } } if (newTransactions.length > 0) { const { error } = await db.from('transactions').insert(newTransactions); if (error) { throw error; } alert(`นำเข้าข้อมูลสำเร็จ ${newTransactions.length} รายการ!`); await fetchAllTransactions(); } else { alert('ไม่พบข้อมูลที่ถูกต้องในไฟล์'); } } catch (error) { console.error('เกิดข้อผิดพลาดในการนำเข้า:', error); alert('เกิดข้อผิดพลาดในการนำเข้า: ' + error.message); } finally { event.target.value = null; } }; reader.readAsBinaryString(file); };

        // ---- APP INITIALIZATION ----
        const initializeApp = async () => { const { data: { session } } = await db.auth.getSession(); if (session) { authContainer.classList.add('hidden'); appContainer.classList.remove('hidden'); userEmailDisplay.textContent = session.user.email; transactionDateEl.valueAsDate = new Date(); populateDateFilters(); await fetchAllTransactions(); } else { authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); } };
        db.auth.onAuthStateChange((event, session) => { if (event === 'SIGNED_IN') { initializeApp(); } else if (event === 'SIGNED_OUT') { authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); allTransactions = []; userEmailDisplay.textContent = ''; document.getElementById('login-form').reset(); } });

        // Event Listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('transaction-form').addEventListener('submit', addTransaction);
        document.getElementById('edit-transaction-form').addEventListener('submit', handleUpdateTransaction);
        yearFilterEl.addEventListener('change', renderUI);
        monthFilterEl.addEventListener('change', renderUI);
        document.getElementById('export-template-btn').addEventListener('click', exportTemplate);
        document.getElementById('export-data-btn').addEventListener('click', exportData);
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
        document.getElementById('import-file').addEventListener('change', importFromXLSX);

        initializeApp();
    </script>
</body>
</html>
